pipeline {
    agent any
    environment {
        VERSION = sh(script: 'awk "/^# VERSION/{getline; print; exit}" ../../app/projects/cronjob/CHANGELOG', returnStdout: true).trim()
    }
    stages {
        stage('Clean go.mod replace') {
            steps {
                dir('../../app/projects/cronjob') {
                    sh "sed -i '/^replace /d' go.mod"
                }
            }
        }
        stage('Build Docker Image') {
            steps {
                dir('../../deploy/docker/dockerfile') {
                    sh "docker build --build-arg VERSION=${VERSION} -f Dockerfile-cronjob -t cronjob:${VERSION} ../../app/projects/cronjob"
                }
            }
        }
        stage('Remove Old Container') {
            steps {
                script {
                    // 停止并移除旧的 cronjob 容器（如果存在）
                    sh '''
                    if docker ps -a --format '{{.Names}}' | grep -Eq '^cronjob$'; then
                      docker stop cronjob || true
                      docker rm cronjob || true
                    fi
                    '''
                }
            }
        }
        stage('Deploy with Docker Compose') {
            steps {
                dir('../../deploy/docker/docker-compose') {
                    sh 'docker compose -f cronjob.yaml up -d --build'
                }
            }
        }
    }
}
